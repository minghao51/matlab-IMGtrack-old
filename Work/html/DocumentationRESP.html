
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>DocumentationRESP</title><meta name="generator" content="MATLAB 8.1"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2014-05-08"><meta name="DC.source" content="DocumentationRESP.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, tt, code { font-size:12px; }
pre { margin:0px 0px 20px; }
pre.error { color:red; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h2>Contents</h2><div><ul><li><a href="#1">Documents</a></li><li><a href="#2">Reading the Data</a></li><li><a href="#3">Searching for the initial crop coordinates and FeatureExtraction Coordinates</a></li><li><a href="#4">For Original Image</a></li><li><a href="#5">Gaussian filter</a></li><li><a href="#6">Test of multiple frame</a></li><li><a href="#7">Segmentation of Tumour</a></li><li><a href="#8">Segmentation method 2: Local Otsu method</a></li><li><a href="#9">Segmentation of Diaphragm</a></li><li><a href="#10">Features Extraction</a></li><li><a href="#11">Verification Section</a></li><li><a href="#12">Plots</a></li><li><a href="#13">Density Plot</a></li><li><a href="#14">Importing and interpretating the RESP data</a></li><li><a href="#15">Plotting the data together nicely</a></li><li><a href="#16">Changing the Data for Diaphragm belt into identical dimension with MRI measurement</a></li><li><a href="#17">Scatter plot of diaphragm parameter</a></li><li><a href="#18">Fitting for confidence</a></li><li><a href="#19">Examing the accuracy of diaphragm segentation</a></li></ul></div><h2>Documents<a name="1"></a></h2><pre class="codeinput"><span class="comment">%Test case for programs in GUI: loading all files as usual, but stop</span>
<span class="comment">% before segmenting, would be changes to test all different segmentation</span>
<span class="comment">% methods</span>

<span class="comment">% %% Clearing and some default settings</span>
clear <span class="string">all</span>
close <span class="string">all</span>

<span class="comment">% docked figures are easier to manage</span>
<span class="comment">% set(0,'DefaultFigureWindowStyle','docked')</span>
set(0,<span class="string">'DefaultFigureWindowStyle'</span>,<span class="string">'normal'</span>)

<span class="comment">% Matlab complains a lot in dock format</span>
iptsetpref(<span class="string">'ImshowInitialMagnification'</span>, <span class="string">'fit'</span>)
warning(<span class="string">'off'</span>,<span class="string">'Images:imshow:magnificationMustBeFitForDockedFigure'</span>); <span class="comment">%Suppress Docked Fit Warning</span>
<span class="comment">%  set(0,'DefaultFigureWindowStyle','normal')</span>

<span class="comment">%Load All functions</span>
 addpath(<span class="string">'C:\Users\Minghao\Desktop\research project\GUI\functions'</span>)
<span class="comment">% %  supress all figure!!! for publishing for now</span>
<span class="comment">% set(0,'DefaultFigureVisible','off')</span>

handles.cropcor1 = [51.51,94.51,75.98,51.98];
handles.cropcor2 = [23.51,201.51,84.98,52.98];
</pre><h2>Reading the Data<a name="2"></a></h2><p>Using matlab UI to navigate into the responding folder</p><pre class="codeinput">[fName,pName] = uigetfile(<span class="string">'*'</span>, <span class="string">'Load data'</span>);
handles.pName = pName; <span class="comment">% to pass this directory for other function</span>
<span class="keyword">if</span> pName == 0, <span class="keyword">return</span>; <span class="keyword">end</span>
<span class="comment">%         dicomlist = dir(fullfile(pName,'Images','*.dcm'));</span>
handles.dicomlist = dir(fullfile(pName, <span class="string">'*'</span>));  <span class="comment">%Generating a list of filename for reading in that directory, based on the 1st letter on the name</span>
handles.dicomlist(~strncmp({handles.dicomlist.name}, fName(1), 1)) = []; <span class="comment">% this yank out those files that isn't start with the same 1st letter as selected file</span>
<span class="comment">% handles.dicominfo = dicominfo(fullfile(pName,handles.dicomlist(1).name));   %reading dicominfo from the very 1st file</span>
<span class="comment">% Sorting the image, so that the order of time/frame are consistent</span>
<span class="comment">% chronologically</span>
[handles.fname inx]= sort_nat({handles.dicomlist.name});
handles.dicomlist = handles.dicomlist(inx);

<span class="keyword">for</span> cnt = 1 : numel(handles.dicomlist)
     handles.data{cnt} = im2double(dicomread(fullfile(pName,handles.dicomlist(cnt).name))); <span class="comment">% directory reading of dicom files</span>
     handles.info{cnt}  = dicominfo(fullfile(pName,handles.dicomlist(cnt).name)) ;
<span class="keyword">end</span>

<span class="comment">%Setting up ImgFolder for items</span>
handles.ImageFolder = pName;                                   <span class="comment">%passing the directory path to textbox/display</span>
</pre><h2>Searching for the initial crop coordinates and FeatureExtraction Coordinates<a name="3"></a></h2><p>Read for crop coordinate data and This search the Image folder for predata.txt, that is supposed to recorded the relevent cropping detaisl</p><pre class="codeinput">handles.predataName = <span class="string">'predata.txt'</span>;
<span class="keyword">if</span> exist(fullfile(pName, handles.predataName), <span class="string">'file'</span>)
    <span class="comment">% File exists.  Do stuff....</span>
<span class="comment">%     % Display that notice the user there is pre-existing crop region</span>
<span class="comment">%     txtInfo = sprintf('There is pre-existing crop region \n cropping and thresholding will generate new predata.txt');</span>
<span class="comment">%     set(handles.txtbox, 'string', txtInfo);</span>

    <span class="comment">% Read the File, and output it into matrix</span>
    M = dlmread(fullfile(pName, handles.predataName));

    <span class="comment">% Updating crop coordinates and method's option</span>
    handles.cropcor1 = M(1,:);
    handles.cropcor2 = M(2,:);
<span class="comment">%     handles.MethodV = M(3,1);</span>
    <span class="keyword">try</span>
    handles.ExtractionCor = M(3,:);
<span class="comment">%     catch exception</span>
<span class="comment">%         figure, imshow(handles.I1{cnt})</span>
<span class="comment">%         [impixel</span>
    <span class="keyword">end</span>
<span class="keyword">else</span>
    <span class="comment">% File does not exist.</span>
    <span class="comment">% Display that notice the user there is not pre-existing crop region</span>
    txtInfo = sprintf(<span class="string">'There is no pre-existing crop region \n will generate predata.txt after cropping and thresholding \n handles.cropcor1'</span>);
    set(handles.txtbox, <span class="string">'string'</span>, txtInfo);

<span class="keyword">end</span>

<span class="comment">% hence after crop and imagesegmentation, write it to the file, though this would</span>
<span class="comment">% require sharing of pName, fullFileName as handles</span>
dlmwrite(fullfile(handles.pName, handles.predataName), <span class="keyword">...</span>
    [handles.cropcor1; handles.cropcor2])
</pre><h2>For Original Image<a name="4"></a></h2><pre class="codeinput"><span class="comment">%This section would crop the relevent section, while aso preserving the I1</span>
<span class="comment">%and I2 original cropping for comparison later on.</span>

<span class="comment">%Cropping and Saving as two cells</span>
<span class="keyword">for</span> cnt = 1 : numel(handles.dicomlist)
    handles.I1{cnt} = imcrop(handles.data{cnt},handles.cropcor1);
    handles.I2{cnt} = imcrop(handles.data{cnt},handles.cropcor2);  <span class="comment">% times 2 because of the orignal half int</span>
<span class="keyword">end</span>

<span class="comment">% %Depiciting the Image</span>
<span class="comment">% figure, imhist(handles.I1{1}), title('Original Image Histogram')</span>
<span class="comment">% figure, imshow( handles.I1{1},[])</span>
</pre><h2>Gaussian filter<a name="5"></a></h2><p>applying gaussian filter to OriginalLocal histogram and CLAHE processed frame just to check the influence</p><pre class="codeinput">    <span class="keyword">for</span> cnt = 1 : numel(handles.dicomlist)
        handles.Gdata{cnt} = Gaussian_fn(handles.data{cnt}, 3,2) ;
        handles.GI1{cnt} = Gaussian_fn(handles.I1{cnt}, 3,2) ;
        handles.GI2{cnt} = Gaussian_fn(handles.I2{cnt}, 3,2) ;
    <span class="keyword">end</span>
</pre><h2>Test of multiple frame<a name="6"></a></h2><pre class="codeinput">test = [1 5 13 20 30];
</pre><h2>Segmentation of Tumour<a name="7"></a></h2><h2>Segmentation method 2: Local Otsu method<a name="8"></a></h2><p>I would expect the same result, but doing local should have the benifit it doing without the OtsuBinV control, at least, for most cases. In the 1st frame, it is observed that LO has better result, though whether that is conslusive remain to be seen</p><pre class="codeinput"><span class="comment">% In both case, the Gaussian filtered image is the best, Histogram</span>
<span class="comment">% Localisation and CLAHE doesn't seems to aid in segmentation much, though,</span>
<span class="comment">% perhaps looking at more frame, more data sets is require for any</span>
<span class="comment">% conclusion</span>

handles.OtsuBinV = 2;

<span class="keyword">for</span> cnt = 1 : numel(handles.dicomlist)
    <span class="comment">%         handles.I1{cnt} = imcrop(handles.dataT{cnt},handles.cropcor1)*2;</span>
    <span class="comment">%         handles.I2{cnt} = imcrop(handles.dataT{cnt},handles.cropcor2)*2;  % times 2 because of the orignal half int</span>
    <span class="comment">% Acting on Original data</span>
    handles.LOI1{cnt} = otsu(handles.I1{cnt},handles.OtsuBinV)*handles.OtsuBinV;
    <span class="comment">% Acting on Gaussian filtered data</span>
    handles.LOGI1{cnt} = otsu(handles.GI1{cnt},handles.OtsuBinV)*handles.OtsuBinV;
    <span class="comment">% Acting on LH data</span>
<span class="comment">%     handles.LOLHI1{cnt} = otsu(handles.LHI1{cnt},handles.OtsuBinV)*handles.OtsuBinV;</span>
    <span class="comment">% Acting on LHG data</span>
<span class="comment">%     handles.LOGLHI1{cnt} = otsu(handles.GLHI1{cnt},handles.OtsuBinV)*handles.OtsuBinV;</span>
    <span class="comment">%     handles.I2{cnt} = otsu(handles.I2{cnt},handles.OtsuBinV)*handles.OtsuBinV;</span>
<span class="keyword">end</span>

<span class="comment">% going through to depict imshow on test frames,</span>
<span class="comment">% for i = 1 : 3</span>
<span class="comment">%     figure('Name',' Original'),...</span>
<span class="comment">%         imshow(handles.I1{test(i)},[],'InitialMagnification',100), title({' Original'})</span>
<span class="comment">%     figure('Name','Local Otsu method on Original'),...</span>
<span class="comment">%         imshow(handles.LOI1{test(i)},[],'InitialMagnification',100), title({'Local Otsu method on Original'}),</span>
<span class="comment">%     figure('Name','Local Otsu method on Gaussian data'),...</span>
<span class="comment">%         imshow(handles.LOGI1{test(i)},[],'InitialMagnification',100), title({'Local Otsu method on Gaussian data'})</span>
<span class="comment">% end</span>
</pre><h2>Segmentation of Diaphragm<a name="9"></a></h2><pre class="codeinput"><span class="keyword">for</span> cnt = 1 : numel(handles.dicomlist)
<span class="comment">%     handles.GI2{cnt} = histeq(handles.GI2{cnt});</span>
    handles.LOGI2{cnt} = otsu(handles.GI2{cnt},handles.OtsuBinV)*handles.OtsuBinV;
<span class="keyword">end</span>
</pre><h2>Features Extraction<a name="10"></a></h2><p>Planning to make a function for features extraction, verifying, plotting</p><pre class="codeinput"><span class="comment">%   Some parameters that enable GUI control, enable all here</span>
handles.Erode_DilateV = 1;
handles.Bwareaopen = 1;
handles.Erode_DilateV = 1;
handles.Imfill = 1;
handles.DynamicUpV = 1;



[ handles ] = FeatureExtract( handles.LOGI1,handles.LOGI2, handles );


<span class="comment">% hence after crop and imagesegmentation, write it to the file, though this would</span>
<span class="comment">% require sharing of pName, fullFileName as handles</span>
dlmwrite(fullfile(handles.pName, handles.predataName), <span class="keyword">...</span>
    [handles.cropcor1; handles.cropcor2; handles.ExtractionCor])
</pre><img vspace="5" hspace="5" src="DocumentationRESP_01.png" alt=""> <h2>Verification Section<a name="11"></a></h2><p>Tumourpixelmargin = 25; Diahphragmpixelmargin = 20;</p><p>[ handles ] = VerifyExpectation(handles, Tumourpixelmargin, Diahphragmpixelmargin );</p><h2>Plots<a name="12"></a></h2><p>Since currently plotting by acquisition time and content time on the siemens MRI makes little sense, the time plot is just, far from resonable</p><pre class="codeinput">handles.SensibleTime = false;
<span class="comment">% The number of frames starting from the first that which makes sense in</span>
<span class="comment">% its temporal time.</span>
handles.TimeSensibleRange = 2;

[ handles ] =PlotsCV( handles );
</pre><pre class="codeoutput">Warning: Unable to interpret TeX string "Displacement(mm) [inferior\caudal]" 
</pre><img vspace="5" hspace="5" src="DocumentationRESP_02.png" alt=""> <img vspace="5" hspace="5" src="DocumentationRESP_03.png" alt=""> <h2>Density Plot<a name="13"></a></h2><pre class="codeinput">    ProbabilityMap = 0;
    <span class="keyword">for</span> cnt = 1: numel(handles.dicomlist)
        ProbabilityMap = ProbabilityMap + handles.dataMap{cnt};
    <span class="keyword">end</span>
    <span class="comment">% Normalising</span>
    ProbabilityMap = ProbabilityMap/numel(handles.dicomlist);

    figure, contourf(ProbabilityMap,<span class="string">'ShowText'</span>,<span class="string">'on'</span>);
axis <span class="string">ij</span>
</pre><img vspace="5" hspace="5" src="DocumentationRESP_04.png" alt=""> <h2>Importing and interpretating the RESP data<a name="14"></a></h2><pre class="codeinput">run(<span class="string">'C:\Users\Minghao\Desktop\research project\GUI\RESP\ImportDataManual'</span>)
run(<span class="string">'C:\Users\Minghao\Desktop\research project\GUI\RESP\InterpretingData'</span>)

<span class="comment">%Due to the Data of DIaphragm belt being recorded in uint16, to ease the</span>
<span class="comment">%path of comparison, it would be chaged into single here</span>
Data=single(Data);
<span class="comment">% plot(time,(Data-mean(Data))*2/max(Data), handles.time_axis, ...</span>
<span class="comment">% (handles.DiaphragmYbound)/max(handles.DiaphragmYbound))</span>
</pre><img vspace="5" hspace="5" src="DocumentationRESP_05.png" alt=""> <h2>Plotting the data together nicely<a name="15"></a></h2><p>Create basic plot for plotting both diaphragm belt and height with respect to time</p><pre class="codeinput">figure;
hold <span class="string">on</span>;
DBelt = line(time, (Data-mean(Data))*2/max(Data));
DMRI = line(handles.time_axis, handles.DiaphragmYbound/max(handles.DiaphragmYbound));
StartPhase = line([handles.time_axis(6), handles.time_axis(6)], [-1.25, 1.25]);

<span class="comment">% Adjust line properties (functional)</span>
set(DBelt                          , <span class="keyword">...</span>
  <span class="string">'Color'</span>           , [0 0 .5]    );
set(DMRI                            , <span class="keyword">...</span>
  <span class="string">'Marker'</span>          , <span class="string">'.'</span>         , <span class="keyword">...</span>
  <span class="string">'Color'</span>           , [.5 .5 .5]  );
set(StartPhase                            , <span class="keyword">...</span>
    <span class="string">'LineStyle'</span>       , <span class="string">'--'</span>      , <span class="keyword">...</span>
  <span class="string">'Marker'</span>          , <span class="string">'.'</span>         , <span class="keyword">...</span>
  <span class="string">'Color'</span>           , [.7 0 0]  );

<span class="comment">% Adjust line properties (aesthetics)</span>
set(DBelt                          , <span class="keyword">...</span>
  <span class="string">'LineWidth'</span>       , 2           );
set(DMRI                            , <span class="keyword">...</span>
  <span class="string">'LineWidth'</span>       , 1           , <span class="keyword">...</span>
  <span class="string">'Marker'</span>          , <span class="string">'o'</span>         , <span class="keyword">...</span>
  <span class="string">'MarkerSize'</span>      , 6           , <span class="keyword">...</span>
  <span class="string">'MarkerEdgeColor'</span> , [.2 .2 .2]  , <span class="keyword">...</span>
  <span class="string">'MarkerFaceColor'</span> , [.7 .7 .7]  );
set(StartPhase                          , <span class="keyword">...</span>
  <span class="string">'LineWidth'</span>       , 1           );

<span class="comment">% Set the axis limits</span>
axis([0 60 -1.25 1.25]);

<span class="comment">% Add labels</span>
hTitle  = title (<span class="string">'Plot of Diaphragm Belt &amp; MRI'</span>);
hXLabel = xlabel(<span class="string">'Time(s)'</span>       );
hYLabel = ylabel(<span class="string">'Normalised Parameter'</span>    );

<span class="comment">% % Add text</span>
<span class="comment">% hText   = text(10, 800, ...</span>
<span class="comment">%   sprintf('{\\itC = %0.1g \\pm %0.1g (CI)}');</span>

<span class="comment">% Add legend</span>
hLegend = legend([DBelt, DMRI StartPhase], <span class="keyword">...</span>
  <span class="string">'Parameter of Diaphragm Belt \it ( D [normalize]) \it'</span> , <span class="keyword">...</span>
  <span class="string">'Diaphragm Height in MRI \it ( \mu [normalize]) \it'</span>, <span class="keyword">...</span>
  <span class="string">'Beginning of phase'</span>);

<span class="comment">% Adjust font</span>
set( gca                             , <span class="string">'FontName'</span>   , <span class="string">'Helvetica'</span> );
set([hTitle, hXLabel, hYLabel]      ,  <span class="string">'FontName'</span>   , <span class="string">'AvantGarde'</span>);
set([hLegend, gca]                   , <span class="string">'FontSize'</span>   , 8           );
set([hXLabel, hYLabel]               , <span class="string">'FontSize'</span>   , 10          );
set( hTitle                          , <span class="string">'FontSize'</span>   , 12          , <span class="keyword">...</span>
                                       <span class="string">'FontWeight'</span> , <span class="string">'bold'</span>      );

<span class="comment">% Adjust axes properties</span>
set(gca, <span class="keyword">...</span>
  <span class="string">'Box'</span>         , <span class="string">'off'</span>     , <span class="keyword">...</span>
  <span class="string">'TickDir'</span>     , <span class="string">'out'</span>     , <span class="keyword">...</span>
  <span class="string">'TickLength'</span>  , [.02 .02] , <span class="keyword">...</span>
  <span class="string">'XMinorTick'</span>  , <span class="string">'on'</span>      , <span class="keyword">...</span>
  <span class="string">'YMinorTick'</span>  , <span class="string">'on'</span>      , <span class="keyword">...</span>
  <span class="string">'YGrid'</span>       , <span class="string">'on'</span>      , <span class="keyword">...</span>
  <span class="string">'XColor'</span>      , [.3 .3 .3], <span class="keyword">...</span>
  <span class="string">'YColor'</span>      , [.3 .3 .3], <span class="keyword">...</span>
  <span class="string">'YTick'</span>       , -1:0.5:1, <span class="keyword">...</span>
  <span class="string">'LineWidth'</span>   , 1         );
 hold <span class="string">off</span>
</pre><img vspace="5" hspace="5" src="DocumentationRESP_06.png" alt=""> <h2>Changing the Data for Diaphragm belt into identical dimension with MRI measurement<a name="16"></a></h2><pre class="codeinput"><span class="comment">% Examine the correlation</span>
<span class="comment">% 0.5/TemporalResolution</span>
<span class="comment">% 0.625/0.0025 = 250</span>

 <span class="keyword">for</span> cnt = 1:numel(handles.DiaphragmYbound)
    DBelt(cnt) = Data(1+(cnt-1)*250);
    Dtime(cnt) = time(1+(cnt-1)*250);
 <span class="keyword">end</span>

<span class="comment">% figure;</span>
<span class="comment">% plot(Dtime, (DBelt-mean(DBelt))*2/max(DBelt), handles.time_axis, ...</span>
<span class="comment">% (handles.DiaphragmYbound)/max(handles.DiaphragmYbound));</span>
</pre><h2>Scatter plot of diaphragm parameter<a name="17"></a></h2><p>scatter((DBelt-mean(DBelt))*2/max(DBelt),(handles.DiaphragmYbound)/max(handles.DiaphragmYbound));</p><pre class="codeinput">figure;
hold <span class="string">on</span>;
BeltVMRI = line((DBelt-mean(DBelt))*2/max(DBelt),(handles.DiaphragmYbound)/max(handles.DiaphragmYbound));
BeltVMRI_period = line((DBelt(6:12)-mean(DBelt))*2/max(DBelt),(handles.DiaphragmYbound(6:12))/max(handles.DiaphragmYbound));
BeltVMRI_6 = line((DBelt(6)-mean(DBelt))*2/max(DBelt),(handles.DiaphragmYbound(6))/max(handles.DiaphragmYbound));

<span class="comment">% Adjust line properties (functional)</span>
set(BeltVMRI                            , <span class="keyword">...</span>
  <span class="string">'LineStyle'</span>       , <span class="string">'-.'</span>      , <span class="keyword">...</span>
  <span class="string">'Marker'</span>          , <span class="string">'.'</span>         , <span class="keyword">...</span>
  <span class="string">'Color'</span>           , [.5 .5 .5]  );

set(BeltVMRI_period                           , <span class="keyword">...</span>
  <span class="string">'Marker'</span>          , <span class="string">'+'</span>         , <span class="keyword">...</span>
  <span class="string">'Color'</span>           , [0 0 .5]    );

set(BeltVMRI_6                            , <span class="keyword">...</span>
  <span class="string">'LineStyle'</span>       , <span class="string">'none'</span>      , <span class="keyword">...</span>
  <span class="string">'Marker'</span>          , <span class="string">'*'</span>         , <span class="keyword">...</span>
  <span class="string">'Color'</span>           , [.0 .5 .0]  );


<span class="comment">% Adjust line properties (aesthetics)</span>
set(BeltVMRI                            , <span class="keyword">...</span>
  <span class="string">'LineWidth'</span>       , 1           , <span class="keyword">...</span>
  <span class="string">'Marker'</span>          , <span class="string">'o'</span>         , <span class="keyword">...</span>
  <span class="string">'MarkerSize'</span>      , 6           , <span class="keyword">...</span>
  <span class="string">'MarkerEdgeColor'</span> , [.2 .2 .2]  , <span class="keyword">...</span>
  <span class="string">'MarkerFaceColor'</span> , [.7 .7 .7]  );
set(BeltVMRI_period                          , <span class="keyword">...</span>
  <span class="string">'LineWidth'</span>       , 2           );
set(BeltVMRI_6                            , <span class="keyword">...</span>
  <span class="string">'Marker'</span>          , <span class="string">'o'</span>         , <span class="keyword">...</span>
  <span class="string">'MarkerEdgeColor'</span> , [.2 .2 .2]  , <span class="keyword">...</span>
  <span class="string">'MarkerFaceColor'</span> , [.7 0 0]  );

<span class="comment">% Add labels</span>
hTitle  = title (<span class="string">'Scatter plot of Diaphragm Belt &amp; MRI Parameter'</span>);
hXLabel = xlabel(<span class="string">'Diaphragm Belt Parameter\it ( D [normalize]) \it '</span>       );
hYLabel = ylabel(<span class="string">'Diaphragm Height in MRI \it ( \mu [normalize])\it'</span>    );


<span class="comment">% Add legend</span>
hLegend = legend([BeltVMRI, BeltVMRI_period, BeltVMRI_6], <span class="keyword">...</span>
  <span class="string">'Parameters Variation of Diaphragm in 1 minute'</span> , <span class="keyword">...</span>
  <span class="string">'Second full respiration cycle'</span>                  , <span class="keyword">...</span>
  <span class="string">'Beginning of phase'</span>  );

<span class="comment">% Adjust font</span>
set( gca                             , <span class="string">'FontName'</span>   , <span class="string">'Helvetica'</span> );
set([hTitle, hXLabel, hYLabel]      ,  <span class="string">'FontName'</span>   , <span class="string">'AvantGarde'</span>);
set([hLegend, gca]                   , <span class="string">'FontSize'</span>   , 8           );
set([hXLabel, hYLabel]               , <span class="string">'FontSize'</span>   , 10          );
set( hTitle                          , <span class="string">'FontSize'</span>   , 12          , <span class="keyword">...</span>
                                       <span class="string">'FontWeight'</span> , <span class="string">'bold'</span>      );

<span class="comment">% Adjust axes properties</span>
set(gca, <span class="keyword">...</span>
  <span class="string">'Box'</span>         , <span class="string">'off'</span>     , <span class="keyword">...</span>
  <span class="string">'TickDir'</span>     , <span class="string">'out'</span>     , <span class="keyword">...</span>
  <span class="string">'TickLength'</span>  , [.02 .02] , <span class="keyword">...</span>
  <span class="string">'XMinorTick'</span>  , <span class="string">'on'</span>      , <span class="keyword">...</span>
  <span class="string">'YMinorTick'</span>  , <span class="string">'on'</span>      , <span class="keyword">...</span>
  <span class="string">'YGrid'</span>       , <span class="string">'on'</span>      , <span class="keyword">...</span>
  <span class="string">'XColor'</span>      , [.3 .3 .3], <span class="keyword">...</span>
  <span class="string">'YColor'</span>      , [.3 .3 .3], <span class="keyword">...</span>
  <span class="string">'XTick'</span>       , -1:0.5:1.25, <span class="keyword">...</span>
  <span class="string">'YTick'</span>       , -1:0.5:1.25, <span class="keyword">...</span>
  <span class="string">'LineWidth'</span>   , 1         );
 hold <span class="string">off</span>

<span class="comment">% % Because to compore the coefficient between the time, the parameter would be reuired to have the same dimension.</span>
<span class="comment">% numel(Data)</span>
<span class="comment">% handles.DiaphragmYbound</span>
<span class="comment">%</span>
<span class="comment">%</span>
<span class="comment">% 0.5/TemporalResolution</span>
<span class="comment">% for cnt = 1:numel(handles.DiaphragmYbound)</span>
<span class="comment">% DBelt(cnt) = Data(1+(cnt)*200)</span>
<span class="comment">% end</span>
<span class="comment">% plot(handles.time_axis, DBelt/max(DBelt), handles.time_axis, ...</span>
<span class="comment">% (handles.DiaphragmYbound)/max(handles.DiaphragmYbound))</span>
</pre><img vspace="5" hspace="5" src="DocumentationRESP_07.png" alt=""> <h2>Fitting for confidence<a name="18"></a></h2><pre class="codeinput"><span class="comment">%Seeing that there appears to be a tread for data at certain peroid, it</span>
<span class="comment">%would perhaps be possible to isolate selected data points and plot them</span>
<span class="comment">%out.</span>

DParameter = ((DBelt-mean(DBelt))*2/max(DBelt));
muParameter = (handles.DiaphragmYbound)/max(handles.DiaphragmYbound);
<span class="comment">%Seeing that the data below \mu &lt; 0.38 have more significant trends</span>
thresh = 0.38;
<span class="comment">%Utilizing arrayfun/cellfun to check for indices of arrays that is below</span>
<span class="comment">%threshold.</span>
vidx = arrayfun(@(x) x &lt; thresh, muParameter);
<span class="comment">%Preserving only those values smaller than threshold level</span>
DParameter_refined = DParameter(vidx);
muParameter_refined = muParameter(vidx);

<span class="comment">%Initial Plot</span>
figure,scatter(DParameter_refined,muParameter_refined);
<span class="comment">% Still no easy fit for the plot, would have to split it into two...</span>

DParameter_refined = DParameter_refined([ [DParameter_refined(1:end)]&gt;-0.2]);
muParameter_refined = muParameter_refined([ [DParameter_refined(1:end)]&gt;-0.2]);

<span class="comment">%Second Plot</span>
figure,scatter(DParameter_refined,muParameter_refined);
</pre><img vspace="5" hspace="5" src="DocumentationRESP_08.png" alt=""> <img vspace="5" hspace="5" src="DocumentationRESP_09.png" alt=""> <h2>Examing the accuracy of diaphragm segentation<a name="19"></a></h2><pre class="codeinput"> <span class="comment">%Using the Import Data function to extract the error for individual</span>
 <span class="comment">%diaphragm</span>

 <span class="comment">% Import the data</span>
[~, ~, raw] = xlsread(<span class="string">'C:\Users\Minghao\Desktop\research project\Thesis\Diaphragm Accuracy\Estimating Error.xlsx'</span>,<span class="string">'Sheet1'</span>,<span class="string">'A1:A90'</span>);

<span class="comment">% Create output variable</span>
EstimatingError = reshape([raw{:}],size(raw));

<span class="comment">% Clear temporary variables</span>
clearvars <span class="string">raw</span>;

 <span class="comment">%To select those who is greater than certain value</span>
<span class="comment">%  EstimatingError_refined = EstimatingError([ [EstimatingError(1:end)]&gt;3]);</span>

 figure;
 hold <span class="string">on</span>;

 DMRI = errorbar(handles.time_axis, handles.DiaphragmYbound, <span class="keyword">...</span>
     EstimatingError*handles.info{1}.PixelSpacing(1));

 <span class="comment">% Normalised version</span>
 <span class="comment">% DMRI = errorbar(handles.time_axis, handles.DiaphragmYbound/max(handles.DiaphragmYbound), ...</span>
 <span class="comment">%     EstimatingError*handles.info{1}.PixelSpacing(1)/max(handles.DiaphragmYbound));</span>

 <span class="comment">% Adjust line properties (functional)</span>
 set(DMRI                            , <span class="keyword">...</span>
     <span class="string">'Marker'</span>          , <span class="string">'.'</span>         , <span class="keyword">...</span>
     <span class="string">'Color'</span>           , [.5 .5 .5]  );

 <span class="comment">% Adjust line properties (aesthetics)</span>
 set(DMRI                            , <span class="keyword">...</span>
     <span class="string">'LineWidth'</span>       , 1           , <span class="keyword">...</span>
     <span class="string">'Marker'</span>          , <span class="string">'o'</span>         , <span class="keyword">...</span>
     <span class="string">'MarkerSize'</span>      , 6           , <span class="keyword">...</span>
     <span class="string">'MarkerEdgeColor'</span> , [.2 .2 .2]  , <span class="keyword">...</span>
     <span class="string">'MarkerFaceColor'</span> , [.7 .7 .7]  );

 <span class="comment">% % Set the axis limits</span>
 <span class="comment">% axis([0 60 -1.25 1.25]);</span>

 <span class="comment">% Add labels</span>
 hTitle  = title (<span class="string">'Plot of Diaphragm height measurement in MRI'</span>);
 hXLabel = xlabel(<span class="string">'Time(s)'</span>       );
 hYLabel = ylabel(<span class="string">'Height Changes (mm) [inferior\caudal] '</span>    );


 <span class="comment">% Add legend</span>
 hLegend = legend([ DMRI ], <span class="keyword">...</span>
     <span class="string">'Diaphragm Height in MRI \it ( \mu ) \it'</span>);

 <span class="comment">% Adjust font</span>
 set( gca                             , <span class="string">'FontName'</span>   , <span class="string">'Helvetica'</span> );
 set([hTitle, hXLabel, hYLabel]      ,  <span class="string">'FontName'</span>   , <span class="string">'AvantGarde'</span>);
 set([hLegend, gca]                   , <span class="string">'FontSize'</span>   , 8           );
 set([hXLabel, hYLabel]               , <span class="string">'FontSize'</span>   , 10          );
 set( hTitle                          , <span class="string">'FontSize'</span>   , 12          , <span class="keyword">...</span>
     <span class="string">'FontWeight'</span> , <span class="string">'bold'</span>      );

 <span class="comment">% Adjust axes properties</span>
 set(gca, <span class="keyword">...</span>
     <span class="string">'Box'</span>         , <span class="string">'off'</span>     , <span class="keyword">...</span>
     <span class="string">'TickDir'</span>     , <span class="string">'out'</span>     , <span class="keyword">...</span>
     <span class="string">'TickLength'</span>  , [.02 .02] , <span class="keyword">...</span>
     <span class="string">'XMinorTick'</span>  , <span class="string">'on'</span>      , <span class="keyword">...</span>
     <span class="string">'YMinorTick'</span>  , <span class="string">'on'</span>      , <span class="keyword">...</span>
     <span class="string">'YGrid'</span>       , <span class="string">'on'</span>      , <span class="keyword">...</span>
     <span class="string">'XColor'</span>      , [.3 .3 .3], <span class="keyword">...</span>
     <span class="string">'YColor'</span>      , [.3 .3 .3], <span class="keyword">...</span>
 <span class="string">'LineWidth'</span>   , 1         );
 hold <span class="string">off</span>
</pre><pre class="codeoutput">Warning: Unable to interpret TeX string "Height Changes (mm) [inferior\caudal] " 
</pre><img vspace="5" hspace="5" src="DocumentationRESP_10.png" alt=""> <p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2013a</a><br></p></div><!--
##### SOURCE BEGIN #####
%% Documents
%Test case for programs in GUI: loading all files as usual, but stop
% before segmenting, would be changes to test all different segmentation
% methods

% %% Clearing and some default settings
clear all
close all

% docked figures are easier to manage
% set(0,'DefaultFigureWindowStyle','docked')
set(0,'DefaultFigureWindowStyle','normal')

% Matlab complains a lot in dock format
iptsetpref('ImshowInitialMagnification', 'fit')
warning('off','Images:imshow:magnificationMustBeFitForDockedFigure'); %Suppress Docked Fit Warning
%  set(0,'DefaultFigureWindowStyle','normal')

%Load All functions
 addpath('C:\Users\Minghao\Desktop\research project\GUI\functions')
% %  supress all figure!!! for publishing for now
% set(0,'DefaultFigureVisible','off')

handles.cropcor1 = [51.51,94.51,75.98,51.98];
handles.cropcor2 = [23.51,201.51,84.98,52.98];

%% Reading the Data
% Using matlab UI to navigate into the responding folder

[fName,pName] = uigetfile('*', 'Load data');
handles.pName = pName; % to pass this directory for other function
if pName == 0, return; end
%         dicomlist = dir(fullfile(pName,'Images','*.dcm'));
handles.dicomlist = dir(fullfile(pName, '*'));  %Generating a list of filename for reading in that directory, based on the 1st letter on the name
handles.dicomlist(~strncmp({handles.dicomlist.name}, fName(1), 1)) = []; % this yank out those files that isn't start with the same 1st letter as selected file
% handles.dicominfo = dicominfo(fullfile(pName,handles.dicomlist(1).name));   %reading dicominfo from the very 1st file
% Sorting the image, so that the order of time/frame are consistent
% chronologically
[handles.fname inx]= sort_nat({handles.dicomlist.name});
handles.dicomlist = handles.dicomlist(inx);

for cnt = 1 : numel(handles.dicomlist)
     handles.data{cnt} = im2double(dicomread(fullfile(pName,handles.dicomlist(cnt).name))); % directory reading of dicom files
     handles.info{cnt}  = dicominfo(fullfile(pName,handles.dicomlist(cnt).name)) ;
end

%Setting up ImgFolder for items
handles.ImageFolder = pName;                                   %passing the directory path to textbox/display

%% Searching for the initial crop coordinates and FeatureExtraction Coordinates
% Read for crop coordinate data and
% This search the Image folder for predata.txt, that is supposed to
% recorded the relevent cropping detaisl

handles.predataName = 'predata.txt';
if exist(fullfile(pName, handles.predataName), 'file')
    % File exists.  Do stuff....
%     % Display that notice the user there is pre-existing crop region
%     txtInfo = sprintf('There is pre-existing crop region \n cropping and thresholding will generate new predata.txt');
%     set(handles.txtbox, 'string', txtInfo);
    
    % Read the File, and output it into matrix
    M = dlmread(fullfile(pName, handles.predataName));
    
    % Updating crop coordinates and method's option
    handles.cropcor1 = M(1,:);
    handles.cropcor2 = M(2,:);
%     handles.MethodV = M(3,1);
    try
    handles.ExtractionCor = M(3,:);
%     catch exception
%         figure, imshow(handles.I1{cnt})
%         [impixel 
    end
else
    % File does not exist.
    % Display that notice the user there is not pre-existing crop region
    txtInfo = sprintf('There is no pre-existing crop region \n will generate predata.txt after cropping and thresholding \n handles.cropcor1');
    set(handles.txtbox, 'string', txtInfo);
    
end

% hence after crop and imagesegmentation, write it to the file, though this would
% require sharing of pName, fullFileName as handles
dlmwrite(fullfile(handles.pName, handles.predataName), ...
    [handles.cropcor1; handles.cropcor2])





%% For Original Image
%This section would crop the relevent section, while aso preserving the I1
%and I2 original cropping for comparison later on.

%Cropping and Saving as two cells
for cnt = 1 : numel(handles.dicomlist)
    handles.I1{cnt} = imcrop(handles.data{cnt},handles.cropcor1);
    handles.I2{cnt} = imcrop(handles.data{cnt},handles.cropcor2);  % times 2 because of the orignal half int
end

% %Depiciting the Image
% figure, imhist(handles.I1{1}), title('Original Image Histogram')
% figure, imshow( handles.I1{1},[])


   
   %% Gaussian filter
% applying gaussian filter to OriginalLocal histogram and CLAHE processed frame
% just to check the influence 

    for cnt = 1 : numel(handles.dicomlist)
        handles.Gdata{cnt} = Gaussian_fn(handles.data{cnt}, 3,2) ;
        handles.GI1{cnt} = Gaussian_fn(handles.I1{cnt}, 3,2) ;
        handles.GI2{cnt} = Gaussian_fn(handles.I2{cnt}, 3,2) ;
    end  
            
%% Test of multiple frame 
test = [1 5 13 20 30];
    
   

%% Segmentation of Tumour
%% Segmentation method 2: Local Otsu method
% I would expect the same result, but doing local should have the benifit
% it doing without the OtsuBinV control, at least, for most cases. In the
% 1st frame, it is observed that LO has better result, though whether that
% is conslusive remain to be seen

% In both case, the Gaussian filtered image is the best, Histogram
% Localisation and CLAHE doesn't seems to aid in segmentation much, though,
% perhaps looking at more frame, more data sets is require for any
% conclusion

handles.OtsuBinV = 2;

for cnt = 1 : numel(handles.dicomlist)
    %         handles.I1{cnt} = imcrop(handles.dataT{cnt},handles.cropcor1)*2;
    %         handles.I2{cnt} = imcrop(handles.dataT{cnt},handles.cropcor2)*2;  % times 2 because of the orignal half int
    % Acting on Original data
    handles.LOI1{cnt} = otsu(handles.I1{cnt},handles.OtsuBinV)*handles.OtsuBinV;
    % Acting on Gaussian filtered data
    handles.LOGI1{cnt} = otsu(handles.GI1{cnt},handles.OtsuBinV)*handles.OtsuBinV;
    % Acting on LH data
%     handles.LOLHI1{cnt} = otsu(handles.LHI1{cnt},handles.OtsuBinV)*handles.OtsuBinV;
    % Acting on LHG data
%     handles.LOGLHI1{cnt} = otsu(handles.GLHI1{cnt},handles.OtsuBinV)*handles.OtsuBinV;
    %     handles.I2{cnt} = otsu(handles.I2{cnt},handles.OtsuBinV)*handles.OtsuBinV;
end

% going through to depict imshow on test frames, 
% for i = 1 : 3
%     figure('Name',' Original'),...
%         imshow(handles.I1{test(i)},[],'InitialMagnification',100), title({' Original'})
%     figure('Name','Local Otsu method on Original'),...
%         imshow(handles.LOI1{test(i)},[],'InitialMagnification',100), title({'Local Otsu method on Original'}),
%     figure('Name','Local Otsu method on Gaussian data'),...
%         imshow(handles.LOGI1{test(i)},[],'InitialMagnification',100), title({'Local Otsu method on Gaussian data'})
% end

    %% Segmentation of Diaphragm
for cnt = 1 : numel(handles.dicomlist)
%     handles.GI2{cnt} = histeq(handles.GI2{cnt});
    handles.LOGI2{cnt} = otsu(handles.GI2{cnt},handles.OtsuBinV)*handles.OtsuBinV;
end

%% Features Extraction
% Planning to make a function for features extraction, verifying, plotting

%   Some parameters that enable GUI control, enable all here
handles.Erode_DilateV = 1;
handles.Bwareaopen = 1;
handles.Erode_DilateV = 1;
handles.Imfill = 1;
handles.DynamicUpV = 1;



[ handles ] = FeatureExtract( handles.LOGI1,handles.LOGI2, handles );


% hence after crop and imagesegmentation, write it to the file, though this would
% require sharing of pName, fullFileName as handles
dlmwrite(fullfile(handles.pName, handles.predataName), ...
    [handles.cropcor1; handles.cropcor2; handles.ExtractionCor])



%% Verification Section
% Tumourpixelmargin = 25;
% Diahphragmpixelmargin = 20;
% 
% [ handles ] = VerifyExpectation(handles, Tumourpixelmargin, Diahphragmpixelmargin );

%% Plots
% Since currently plotting by acquisition time and content time on the siemens MRI
% makes little sense, the time plot is just, far from resonable
handles.SensibleTime = false;
% The number of frames starting from the first that which makes sense in
% its temporal time.
handles.TimeSensibleRange = 2;

[ handles ] =PlotsCV( handles );


%% Density Plot

    ProbabilityMap = 0;
    for cnt = 1: numel(handles.dicomlist)
        ProbabilityMap = ProbabilityMap + handles.dataMap{cnt};
    end
    % Normalising
    ProbabilityMap = ProbabilityMap/numel(handles.dicomlist);
   
    figure, contourf(ProbabilityMap,'ShowText','on');
axis ij

%% Importing and interpretating the RESP data
run('C:\Users\Minghao\Desktop\research project\GUI\RESP\ImportDataManual')
run('C:\Users\Minghao\Desktop\research project\GUI\RESP\InterpretingData')

%Due to the Data of DIaphragm belt being recorded in uint16, to ease the
%path of comparison, it would be chaged into single here
Data=single(Data);
% plot(time,(Data-mean(Data))*2/max(Data), handles.time_axis, ...
% (handles.DiaphragmYbound)/max(handles.DiaphragmYbound))


%% Plotting the data together nicely
% Create basic plot for plotting both diaphragm belt and height with
% respect to time
figure;
hold on;
DBelt = line(time, (Data-mean(Data))*2/max(Data));
DMRI = line(handles.time_axis, handles.DiaphragmYbound/max(handles.DiaphragmYbound));
StartPhase = line([handles.time_axis(6), handles.time_axis(6)], [-1.25, 1.25]);

% Adjust line properties (functional)
set(DBelt                          , ...
  'Color'           , [0 0 .5]    );
set(DMRI                            , ...
  'Marker'          , '.'         , ...
  'Color'           , [.5 .5 .5]  );
set(StartPhase                            , ...
    'LineStyle'       , 'REPLACE_WITH_DASH_DASH'      , ...
  'Marker'          , '.'         , ...
  'Color'           , [.7 0 0]  );

% Adjust line properties (aesthetics)
set(DBelt                          , ...
  'LineWidth'       , 2           );
set(DMRI                            , ...
  'LineWidth'       , 1           , ...
  'Marker'          , 'o'         , ...
  'MarkerSize'      , 6           , ...
  'MarkerEdgeColor' , [.2 .2 .2]  , ...
  'MarkerFaceColor' , [.7 .7 .7]  );
set(StartPhase                          , ...
  'LineWidth'       , 1           );

% Set the axis limits
axis([0 60 -1.25 1.25]);

% Add labels
hTitle  = title ('Plot of Diaphragm Belt & MRI');
hXLabel = xlabel('Time(s)'       );
hYLabel = ylabel('Normalised Parameter'    );

% % Add text
% hText   = text(10, 800, ...
%   sprintf('{\\itC = %0.1g \\pm %0.1g (CI)}');

% Add legend
hLegend = legend([DBelt, DMRI StartPhase], ...
  'Parameter of Diaphragm Belt \it ( D [normalize]) \it' , ...
  'Diaphragm Height in MRI \it ( \mu [normalize]) \it', ...
  'Beginning of phase');
  
% Adjust font
set( gca                             , 'FontName'   , 'Helvetica' );
set([hTitle, hXLabel, hYLabel]      ,  'FontName'   , 'AvantGarde');
set([hLegend, gca]                   , 'FontSize'   , 8           );
set([hXLabel, hYLabel]               , 'FontSize'   , 10          );
set( hTitle                          , 'FontSize'   , 12          , ...
                                       'FontWeight' , 'bold'      );

% Adjust axes properties
set(gca, ...
  'Box'         , 'off'     , ...
  'TickDir'     , 'out'     , ...
  'TickLength'  , [.02 .02] , ...
  'XMinorTick'  , 'on'      , ...
  'YMinorTick'  , 'on'      , ...
  'YGrid'       , 'on'      , ...
  'XColor'      , [.3 .3 .3], ...
  'YColor'      , [.3 .3 .3], ...
  'YTick'       , -1:0.5:1, ...
  'LineWidth'   , 1         );
 hold off
 
 %% Changing the Data for Diaphragm belt into identical dimension with MRI measurement
 
% Examine the correlation
% 0.5/TemporalResolution
% 0.625/0.0025 = 250

 for cnt = 1:numel(handles.DiaphragmYbound)
    DBelt(cnt) = Data(1+(cnt-1)*250);
    Dtime(cnt) = time(1+(cnt-1)*250);
 end

% figure;
% plot(Dtime, (DBelt-mean(DBelt))*2/max(DBelt), handles.time_axis, ...
% (handles.DiaphragmYbound)/max(handles.DiaphragmYbound));


%% Scatter plot of diaphragm parameter
% scatter((DBelt-mean(DBelt))*2/max(DBelt),(handles.DiaphragmYbound)/max(handles.DiaphragmYbound));

figure;
hold on;
BeltVMRI = line((DBelt-mean(DBelt))*2/max(DBelt),(handles.DiaphragmYbound)/max(handles.DiaphragmYbound));
BeltVMRI_period = line((DBelt(6:12)-mean(DBelt))*2/max(DBelt),(handles.DiaphragmYbound(6:12))/max(handles.DiaphragmYbound));
BeltVMRI_6 = line((DBelt(6)-mean(DBelt))*2/max(DBelt),(handles.DiaphragmYbound(6))/max(handles.DiaphragmYbound));

% Adjust line properties (functional)
set(BeltVMRI                            , ...
  'LineStyle'       , '-.'      , ...
  'Marker'          , '.'         , ...
  'Color'           , [.5 .5 .5]  );

set(BeltVMRI_period                           , ...
  'Marker'          , '+'         , ...
  'Color'           , [0 0 .5]    );

set(BeltVMRI_6                            , ...
  'LineStyle'       , 'none'      , ...
  'Marker'          , '*'         , ...
  'Color'           , [.0 .5 .0]  );


% Adjust line properties (aesthetics)
set(BeltVMRI                            , ...
  'LineWidth'       , 1           , ...
  'Marker'          , 'o'         , ...
  'MarkerSize'      , 6           , ...
  'MarkerEdgeColor' , [.2 .2 .2]  , ...
  'MarkerFaceColor' , [.7 .7 .7]  );
set(BeltVMRI_period                          , ...
  'LineWidth'       , 2           );
set(BeltVMRI_6                            , ...
  'Marker'          , 'o'         , ...
  'MarkerEdgeColor' , [.2 .2 .2]  , ...
  'MarkerFaceColor' , [.7 0 0]  );

% Add labels
hTitle  = title ('Scatter plot of Diaphragm Belt & MRI Parameter');
hXLabel = xlabel('Diaphragm Belt Parameter\it ( D [normalize]) \it '       );
hYLabel = ylabel('Diaphragm Height in MRI \it ( \mu [normalize])\it'    );


% Add legend
hLegend = legend([BeltVMRI, BeltVMRI_period, BeltVMRI_6], ...
  'Parameters Variation of Diaphragm in 1 minute' , ...
  'Second full respiration cycle'                  , ...
  'Beginning of phase'  );

% Adjust font
set( gca                             , 'FontName'   , 'Helvetica' );
set([hTitle, hXLabel, hYLabel]      ,  'FontName'   , 'AvantGarde');
set([hLegend, gca]                   , 'FontSize'   , 8           );
set([hXLabel, hYLabel]               , 'FontSize'   , 10          );
set( hTitle                          , 'FontSize'   , 12          , ...
                                       'FontWeight' , 'bold'      );

% Adjust axes properties
set(gca, ...
  'Box'         , 'off'     , ...
  'TickDir'     , 'out'     , ...
  'TickLength'  , [.02 .02] , ...
  'XMinorTick'  , 'on'      , ...
  'YMinorTick'  , 'on'      , ...
  'YGrid'       , 'on'      , ...
  'XColor'      , [.3 .3 .3], ...
  'YColor'      , [.3 .3 .3], ...
  'XTick'       , -1:0.5:1.25, ...
  'YTick'       , -1:0.5:1.25, ...
  'LineWidth'   , 1         );
 hold off

% % Because to compore the coefficient between the time, the parameter would be reuired to have the same dimension.
% numel(Data)
% handles.DiaphragmYbound
% 
% 
% 0.5/TemporalResolution
% for cnt = 1:numel(handles.DiaphragmYbound)
% DBelt(cnt) = Data(1+(cnt)*200)
% end
% plot(handles.time_axis, DBelt/max(DBelt), handles.time_axis, ...
% (handles.DiaphragmYbound)/max(handles.DiaphragmYbound))



%% Fitting for confidence
%Seeing that there appears to be a tread for data at certain peroid, it
%would perhaps be possible to isolate selected data points and plot them
%out.

DParameter = ((DBelt-mean(DBelt))*2/max(DBelt));
muParameter = (handles.DiaphragmYbound)/max(handles.DiaphragmYbound);
%Seeing that the data below \mu < 0.38 have more significant trends
thresh = 0.38;
%Utilizing arrayfun/cellfun to check for indices of arrays that is below
%threshold.
vidx = arrayfun(@(x) x < thresh, muParameter);
%Preserving only those values smaller than threshold level
DParameter_refined = DParameter(vidx);
muParameter_refined = muParameter(vidx);

%Initial Plot
figure,scatter(DParameter_refined,muParameter_refined);
% Still no easy fit for the plot, would have to split it into two...

DParameter_refined = DParameter_refined([ [DParameter_refined(1:end)]>-0.2]);
muParameter_refined = muParameter_refined([ [DParameter_refined(1:end)]>-0.2]);

%Second Plot
figure,scatter(DParameter_refined,muParameter_refined);
 
 %% Examing the accuracy of diaphragm segentation
 %Using the Import Data function to extract the error for individual
 %diaphragm
 
 % Import the data
[~, ~, raw] = xlsread('C:\Users\Minghao\Desktop\research project\Thesis\Diaphragm Accuracy\Estimating Error.xlsx','Sheet1','A1:A90');

% Create output variable
EstimatingError = reshape([raw{:}],size(raw));

% Clear temporary variables
clearvars raw;

 %To select those who is greater than certain value
%  EstimatingError_refined = EstimatingError([ [EstimatingError(1:end)]>3]);

 figure;
 hold on;
 
 DMRI = errorbar(handles.time_axis, handles.DiaphragmYbound, ...
     EstimatingError*handles.info{1}.PixelSpacing(1));
  
 % Normalised version
 % DMRI = errorbar(handles.time_axis, handles.DiaphragmYbound/max(handles.DiaphragmYbound), ...
 %     EstimatingError*handles.info{1}.PixelSpacing(1)/max(handles.DiaphragmYbound));
 
 % Adjust line properties (functional)
 set(DMRI                            , ...
     'Marker'          , '.'         , ...
     'Color'           , [.5 .5 .5]  );
 
 % Adjust line properties (aesthetics)
 set(DMRI                            , ...
     'LineWidth'       , 1           , ...
     'Marker'          , 'o'         , ...
     'MarkerSize'      , 6           , ...
     'MarkerEdgeColor' , [.2 .2 .2]  , ...
     'MarkerFaceColor' , [.7 .7 .7]  );
 
 % % Set the axis limits
 % axis([0 60 -1.25 1.25]);
 
 % Add labels
 hTitle  = title ('Plot of Diaphragm height measurement in MRI');
 hXLabel = xlabel('Time(s)'       );
 hYLabel = ylabel('Height Changes (mm) [inferior\caudal] '    );
 
 
 % Add legend
 hLegend = legend([ DMRI ], ...
     'Diaphragm Height in MRI \it ( \mu ) \it');
 
 % Adjust font
 set( gca                             , 'FontName'   , 'Helvetica' );
 set([hTitle, hXLabel, hYLabel]      ,  'FontName'   , 'AvantGarde');
 set([hLegend, gca]                   , 'FontSize'   , 8           );
 set([hXLabel, hYLabel]               , 'FontSize'   , 10          );
 set( hTitle                          , 'FontSize'   , 12          , ...
     'FontWeight' , 'bold'      );
 
 % Adjust axes properties
 set(gca, ...
     'Box'         , 'off'     , ...
     'TickDir'     , 'out'     , ...
     'TickLength'  , [.02 .02] , ...
     'XMinorTick'  , 'on'      , ...
     'YMinorTick'  , 'on'      , ...
     'YGrid'       , 'on'      , ...
     'XColor'      , [.3 .3 .3], ...
     'YColor'      , [.3 .3 .3], ...
 'LineWidth'   , 1         );
 hold off
 

 

 
##### SOURCE END #####
--></body></html>